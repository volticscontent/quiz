<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="images/logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OKC Thunder Store</title>
    
    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      
      fbq('init', '10005843282818404');
      fbq('track', 'PageView');
    </script>
    <!-- End Meta Pixel Code -->
    
    <!-- TikTok Pixel Code -->
    <script>
      !function (w, d, t) {
        w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};

        ttq.load('CQI0UF3C77UBN1SEFPV0', {
          access_token: '42d551c4e66ac8e41f1db8bbfbe4457e84fa4e96'
        });
        ttq.page();
      }(window, document, 'ttq');
    </script>
    <!-- End TikTok Pixel Code -->
    
    <!-- SISTEMA UNIFICADO DE TRACKING -->
    <script>
      window.dataLayer = window.dataLayer || [];
      
      // 🎯 SISTEMA CENTRALIZADO DE TRACKING - ZERO DUPLICAÇÕES
      window.UnifiedTracking = {
        // Controle de eventos enviados
        sentEvents: new Set(),
        eventQueue: [],
        isProcessing: false,
        
        // 🚨 NOVO: Controle de Rate Limiting
        lastRequestTime: 0,
        minTimeBetweenRequests: 1000, // 1 segundo entre requisições
        checkoutInProgress: false,
        lastCheckoutTime: 0,
        
        // Gerar ID único para cada evento
        generateEventId: function(eventName, data) {
          const key = eventName + '_' + JSON.stringify(data);
          return btoa(key).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
        },
        
        // 🚨 NOVO: Verificar se pode fazer requisição
        canMakeRequest: function() {
          const now = Date.now();
          const timeSinceLastRequest = now - this.lastRequestTime;
          
          if (timeSinceLastRequest < this.minTimeBetweenRequests) {
            console.log(`⏳ Rate limit: aguardando ${this.minTimeBetweenRequests - timeSinceLastRequest}ms`);
            return false;
          }
          
          this.lastRequestTime = now;
          return true;
        },
        
        // 🚨 NOVO: Verificar se pode fazer checkout
        canInitiateCheckout: function() {
          const now = Date.now();
          const timeSinceLastCheckout = now - this.lastCheckoutTime;
          
          // 🚨 RESET AUTOMÁTICO SE MUITO TEMPO PASSOU
          if (this.checkoutInProgress && timeSinceLastCheckout > 30000) { // 30 segundos
            console.log('🔄 Reset automático do checkout após timeout');
            this.checkoutInProgress = false;
          }
          
          if (this.checkoutInProgress) {
            console.log('🚫 Checkout já em andamento, bloqueando duplicação');
            return false;
          }
          
          if (timeSinceLastCheckout < 5000) { // 5 segundos entre checkouts
            console.log('🚫 Checkout muito recente, aguardando...');
            return false;
          }
          
          return true;
        },
        
        // 🚨 NOVO: Reset manual do checkout
        resetCheckout: function() {
          this.checkoutInProgress = false;
          console.log('🔄 Status de checkout resetado manualmente');
        },
        
        // Função principal para enviar eventos
        track: function(eventName, eventData = {}) {
          // 🚨 Verificar rate limiting
          if (!this.canMakeRequest()) {
            return false;
          }
          
          const eventId = this.generateEventId(eventName, eventData);
          
          if (this.sentEvents.has(eventId)) {
            console.log(`🚫 Evento ${eventName} já enviado, ignorando duplicação`);
            return false;
          }
          
          this.eventQueue.push({
            id: eventId,
            name: eventName,
            data: eventData,
            timestamp: Date.now()
          });
          
          this.processQueue();
          return true;
        },
        
        // Processar fila de eventos
        processQueue: function() {
          if (this.isProcessing || this.eventQueue.length === 0) {
            return;
          }
          
          this.isProcessing = true;
          const event = this.eventQueue.shift();
          
          try {
            this.sentEvents.add(event.id);
            this.sendToAllPlatforms(event.name, event.data);
          } catch (error) {
            console.error(`❌ Erro ao enviar evento ${event.name}:`, error);
            this.sentEvents.delete(event.id);
          }
          
          setTimeout(() => {
            this.isProcessing = false;
            this.processQueue();
          }, 100);
        },
        
        // Enviar para todas as plataformas
        sendToAllPlatforms: function(eventName, eventData) {
          dataLayer.push({
            event: eventName,
            ...eventData,
            sent_at: new Date().toISOString()
          });
          
          if (window.fbq && eventData) {
            this.sendToMetaPixel(eventName, eventData);
          }
          
          if (window.ttq && eventData) {
            this.sendToTikTok(eventName, eventData);
          }
          
          if (window.utmify && eventData) {
            this.sendToUTMify(eventName, eventData);
          }
        },
        
        // Enviar para Meta Pixel
        sendToMetaPixel: function(eventName, eventData) {
          const utmParams = {
            utm_source: eventData.utm_source,
            utm_medium: eventData.utm_medium,
            utm_campaign: eventData.utm_campaign,
            quiz_source: eventData.quiz_source,
            quiz_completed: eventData.quiz_completed,
            discount_unlocked: eventData.discount_unlocked
          };
          
          switch(eventName) {
            case 'add_to_cart':
              fbq('track', 'AddToCart', {
                content_name: eventData.item_name || eventData.content_name,
                content_ids: [eventData.item_id || eventData.content_ids?.[0]],
                content_type: 'product',
                value: eventData.value,
                currency: eventData.currency || 'USD',
                custom_data: {
                  utm_source: utmParams.utm_source,
                  utm_medium: utmParams.utm_medium,
                  utm_campaign: utmParams.utm_campaign,
                  quiz_source: utmParams.quiz_source,
                  event_source: eventData.event_source,
                  shopify_product_id: eventData.shopify_product_id
                }
              });
              break;
              
            case 'initiate_checkout':
              fbq('track', 'InitiateCheckout P3', {
                value: eventData.value,
                currency: eventData.currency || 'USD',
                num_items: eventData.num_items || 1,
                custom_data: {
                  utm_source: utmParams.utm_source,
                  utm_medium: utmParams.utm_medium,
                  utm_campaign: utmParams.utm_campaign,
                  quiz_source: utmParams.quiz_source,
                  event_source: eventData.event_source,
                  p3initiate: 'true'
                }
              });
              break;
              
            case 'view_item':
              fbq('track', 'ViewContent', {
                content_name: eventData.item_name || eventData.content_name,
                content_ids: [eventData.item_id || eventData.content_ids?.[0]],
                content_type: 'product',
                value: eventData.value,
                currency: eventData.currency || 'USD',
                custom_data: {
                  utm_source: utmParams.utm_source,
                  utm_medium: utmParams.utm_medium,
                  utm_campaign: utmParams.utm_campaign,
                  quiz_source: utmParams.quiz_source,
                  event_source: eventData.event_source
                }
              });
              break;
              
            case 'quiz_redirect':
              fbq('track', 'Lead', {
                content_name: 'Thunder Quiz Completed',
                value: eventData.value || 0,
                currency: 'USD',
                custom_data: {
                  utm_source: utmParams.utm_source,
                  utm_medium: utmParams.utm_medium,
                  utm_campaign: utmParams.utm_campaign,
                  quiz_completed: utmParams.quiz_completed,
                  discount_unlocked: utmParams.discount_unlocked,
                  event_source: eventData.event_source || 'quiz'
                }
              });
              break;
              
            default:
              fbq('trackCustom', eventName, {
                ...eventData,
                custom_data: {
                  utm_source: utmParams.utm_source,
                  utm_medium: utmParams.utm_medium,
                  utm_campaign: utmParams.utm_campaign,
                  quiz_source: utmParams.quiz_source,
                  event_source: eventData.event_source
                }
              });
          }
        },
        
        // Enviar para TikTok
        sendToTikTok: function(eventName, eventData) {
          if (!window.ttq || typeof window.ttq.track !== 'function') {
            console.warn('⚠️ TikTok não está disponível');
            return;
          }
          
          try {
            const baseData = {
              content_type: 'product',
              content_ids: [eventData.item_id || eventData.content_ids?.[0]],
              value: eventData.value || 0,
              currency: eventData.currency || 'USD',
              utm_source: eventData.utm_source,
              utm_medium: eventData.utm_medium,
              utm_campaign: eventData.utm_campaign,
              quiz_source: eventData.quiz_source,
              quiz_completed: eventData.quiz_completed,
              discount_unlocked: eventData.discount_unlocked
            };
            
            switch(eventName) {
              case 'add_to_cart':
                ttq.track('AddToCart', baseData);
                break;
                
              case 'initiate_checkout':
                ttq.track('InitiateCheckout P3', {
                  ...baseData,
                  p3initiate: 'true'
                });
                break;
                
              case 'view_item':
                ttq.track('ViewContent', baseData);
                break;
                
              default:
                ttq.track(eventName, baseData);
            }
          } catch (error) {
            console.error('❌ Erro ao enviar para TikTok:', error);
          }
        },
        
        // Enviar para UTMify
        sendToUTMify: function(eventName, eventData) {
          if (!window.utmify || typeof window.utmify.track !== 'function') {
            console.warn('⚠️ UTMify não está disponível');
            return;
          }
          
          try {
            const utmifyData = {
              event_name: eventName,
              event_source: eventData.event_source || 'shopify_button',
              product_id: eventData.item_id || eventData.shopify_product_id,
              product_name: eventData.item_name || eventData.content_name,
              value: eventData.value || 0,
              currency: eventData.currency || 'USD',
              quantity: eventData.quantity || 1,
              utm_source: eventData.utm_source,
              utm_medium: eventData.utm_medium,
              utm_campaign: eventData.utm_campaign,
              utm_content: eventData.utm_content || 'buy_button',
              utm_term: eventData.utm_term || 'shopify_checkout',
              quiz_source: eventData.quiz_source,
              quiz_completed: eventData.quiz_completed,
              discount_unlocked: eventData.discount_unlocked,
              shopify_domain: eventData.shopify_domain,
              shopify_product_id: eventData.shopify_product_id,
              timestamp: new Date().toISOString(),
              page_url: window.location.href,
              referrer: document.referrer
            };
            
            window.utmify.track(eventName, utmifyData);
          } catch (error) {
            console.error('❌ Erro ao enviar para UTMify:', error);
          }
        },
        
        // Limpar eventos antigos
        cleanOldEvents: function() {
          const now = Date.now();
          const maxAge = 60 * 60 * 1000; // 1 hora
          
          this.eventQueue = this.eventQueue.filter(event => 
            (now - event.timestamp) < maxAge
          );
          
          if (this.sentEvents.size > 1000) {
            this.sentEvents.clear();
          }
        },
        
        // 🚨 NOVO: Inicializar sistema
        init: function() {
          console.log('🎯 Sistema Unificado de Tracking iniciado');
          
          // Limpeza periódica a cada 5 minutos
          setInterval(() => {
            this.cleanOldEvents();
          }, 5 * 60 * 1000);
          
          // Reset automático do checkout a cada minuto
          setInterval(() => {
            const now = Date.now();
            if (this.checkoutInProgress && (now - this.lastCheckoutTime) > 60000) {
              console.log('🔄 Reset automático do checkout após 1 minuto');
              this.checkoutInProgress = false;
            }
          }, 60 * 1000);
          
          // Debug do sistema a cada 30 segundos
          if (window.location.search.includes('debug=true')) {
            setInterval(() => {
              console.log('📊 Status do Sistema:', {
                sentEvents: this.sentEvents.size,
                eventQueue: this.eventQueue.length,
                checkoutInProgress: this.checkoutInProgress,
                lastCheckoutTime: this.lastCheckoutTime,
                lastRequestTime: this.lastRequestTime
              });
            }, 30 * 1000);
          }
        }
      };
      
      // Função global simplificada
      window.trackEvent = function(eventName, eventData) {
        return window.UnifiedTracking.track(eventName, eventData);
      };
      
      // Função para obter dados UTM
      window.getUTMData = function() {
        const params = new URLSearchParams(window.location.search);
        const quizData = JSON.parse(localStorage.getItem('thunder_quiz_data') || '{}');
        const referrer = document.referrer;
        
        // Capturar todas as UTMs possíveis
        const allUTMs = {
          // UTMs da URL (prioridade 1)
          utm_source: params.get('utm_source'),
          utm_medium: params.get('utm_medium'),
          utm_campaign: params.get('utm_campaign'),
          utm_content: params.get('utm_content'),
          utm_term: params.get('utm_term'),
          
          // UTMs do Quiz (prioridade 2)
          quiz_source: quizData.source,
          quiz_completed: quizData.quiz_completed,
          quiz_discount: quizData.discount_unlocked,
          quiz_utm_source: quizData.utm_source,
          quiz_utm_medium: quizData.utm_medium,
          quiz_utm_campaign: quizData.utm_campaign,
          
          // Dados adicionais
          referrer: referrer,
          page_url: window.location.href,
          timestamp: new Date().toISOString(),
          
          // Dados do dispositivo
          device_type: window.innerWidth <= 768 ? 'mobile' : 'desktop',
          screen_resolution: `${window.screen.width}x${window.screen.height}`,
          
          // Dados da sessão
          session_id: localStorage.getItem('session_id') || crypto.randomUUID(),
          visit_count: parseInt(localStorage.getItem('visit_count') || '0') + 1
        };
        
        // Atualizar dados da sessão
        localStorage.setItem('session_id', allUTMs.session_id);
        localStorage.setItem('visit_count', allUTMs.visit_count.toString());
        
        // Determinar valores finais (com prioridades)
        return {
          // UTMs principais
          utm_source: params.get('utm_source') || quizData.utm_source || 'direct',
          utm_medium: params.get('utm_medium') || quizData.utm_medium || 'none',
          utm_campaign: params.get('utm_campaign') || quizData.utm_campaign || 'none',
          utm_content: params.get('utm_content') || 'buy_button',
          utm_term: params.get('utm_term') || 'shopify_checkout',
          
          // Dados do quiz
          quiz_source: quizData.source || null,
          quiz_completed: quizData.quiz_completed || false,
          discount_unlocked: quizData.discount_unlocked || false,
          
          // Metadados
          referrer: referrer,
          page_url: window.location.href,
          timestamp: allUTMs.timestamp,
          device_type: allUTMs.device_type,
          screen_resolution: allUTMs.screen_resolution,
          session_id: allUTMs.session_id,
          visit_count: allUTMs.visit_count
        };
      };

      // Função para serializar UTMs para URL
      window.getSerializedUTMs = function() {
        const utmData = window.getUTMData();
        const essentialParams = [
          'utm_source',
          'utm_medium', 
          'utm_campaign',
          'utm_content',
          'utm_term'
        ];
        
        // Filtrar apenas UTMs com valores válidos
        const validUTMs = {};
        essentialParams.forEach(key => {
          if (utmData[key] && utmData[key] !== 'direct' && utmData[key] !== 'none') {
            validUTMs[key] = utmData[key];
          }
        });
        
        // Adicionar dados do quiz se existirem
        if (utmData.quiz_completed) {
          validUTMs.quiz = 'completed';
        }
        if (utmData.discount_unlocked) {
          validUTMs.discount = 'unlocked';
        }
        
        return Object.entries(validUTMs)
          .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
          .join('&');
      };

      // Atualizar função de checkout para incluir todos os dados
      function updateCheckoutWithUTMs(cart) {
        try {
          const utmData = window.getUTMData();
          
          // Enviar para Meta Pixel com dados completos
          fbq('track', 'InitiateCheckout P3', {
            value: cart.model.subtotal,
            currency: 'USD',
            content_type: 'product',
            content_ids: cart.model.lineItems.map(item => item.variant.id),
            custom_data: {
              ...utmData,
              event_source: 'shopify_checkout',
              p3initiate: 'true'
            }
          });

          // Enviar para TikTok com dados completos
          ttq.track('InitiateCheckout P3', {
            content_type: 'product',
            content_ids: cart.model.lineItems.map(item => item.variant.id),
            quantity: cart.model.lineItems.reduce((total, item) => total + item.quantity, 0),
            value: cart.model.subtotal,
            currency: 'USD',
            p3initiate: 'true',
            ...utmData
          });
          
          // Construir URL do checkout com UTMs essenciais
          const utmString = window.getSerializedUTMs();
          const checkoutUrl = cart.model.webUrl;
          
          if (!checkoutUrl) {
            console.error('❌ URL do checkout não encontrada');
            return true;
          }
          
          // Adicionar UTMs e debug
          const finalUrl = checkoutUrl + (checkoutUrl.includes('?') ? '&' : '?') + utmString;
          
          // Debug completo
          console.log('🛒 Checkout Iniciado:', {
            url: finalUrl,
            utmData: utmData,
            cartItems: cart.model.lineItems,
            total: cart.model.subtotal
          });
          
          // Redirecionar
          window.location = finalUrl;
          return false;
          
        } catch (error) {
          console.error('❌ Erro no checkout:', error);
          return true;
        }
      }

      // Função para capturar dados do quiz
      window.captureQuizData = function() {
        const referrer = document.referrer;
        const urlParams = new URLSearchParams(window.location.search);
        
        if (referrer.includes('quiz.nbathunder.shop')) {
          const quizData = {
            source: 'thunder_quiz',
            referrer: referrer,
            quiz_completed: urlParams.get('quiz') === 'completed',
            discount_unlocked: urlParams.get('discount') === 'unlocked',
            utm_source: urlParams.get('utm_source') || 'quiz',
            utm_medium: urlParams.get('utm_medium') || 'quiz_redirect',
            utm_campaign: urlParams.get('utm_campaign') || 'thunder_quiz_70off'
          };
          
          localStorage.setItem('thunder_quiz_data', JSON.stringify(quizData));
          window.UnifiedTracking.track('quiz_redirect', quizData);
          return quizData;
        }
        
        return null;
      };

      // Inicializar Shopify com UTM
      window.initializeShopifyWithUTM = function() {
        var scriptURL = 'https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js';
        
        if (window.ShopifyBuy) {
          if (window.ShopifyBuy.UI) {
            ShopifyBuyInit();
          } else {
            loadScript();
          }
        } else {
          loadScript();
        }
        
        function loadScript() {
          var script = document.createElement('script');
          script.async = true;
          script.src = scriptURL;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(script);
          script.onload = ShopifyBuyInit;
        }
        
        function ShopifyBuyInit() {
          // 🎯 USAR CONFIGURAÇÕES CENTRALIZADAS
          const config = window.ShopifyHelper?.getConfig() || {
            domain: 's1qbpp-6n.myshopify.com',
            storefrontAccessToken: 'f8b561a2fc2d25e9124114d58c0b7643',
            apiVersion: '2024-01'
          }
          
          var client = window.ShopifyBuy.buildClient(config);

          // 🎨 USAR ESTILOS CENTRALIZADOS
          const buttonStyles = window.ShopifyHelper?.getButtonStyles() || {
            backgroundColor: '#20a714',
            hoverColor: '#20a714',
            borderRadius: '40px'
          }

          // Configuração padrão dos botões
          const defaultOptions = {
            "product": {
              "styles": {
                "product": {
                  "@media (min-width: 601px)": {
                    "max-width": "calc(25% - 20px)",
                    "margin-left": "20px",
                    "margin-bottom": "50px"
                  }
                },
                "button": {
                  "font-weight": "bold",
                  ":hover": {
                    "background-color": buttonStyles.hoverColor
                  },
                  "background-color": buttonStyles.backgroundColor,
                  ":focus": {
                    "background-color": buttonStyles.hoverColor
                  },
                  "border-radius": buttonStyles.borderRadius,
                  "padding-left": "95px",
                  "padding-right": "95px"
                }
              },
              "contents": {
                "img": false,
                "title": false,
                "price": false
              },
              "text": {
                "button": "Add to cart"
              }
            },
            "productSet": {
              "styles": {
                "products": {
                  "@media (min-width: 601px)": {
                    "margin-left": "-20px"
                  }
                }
              }
            },
            "modalProduct": {
              "contents": {
                "img": false,
                "imgWithCarousel": true,
                "button": false,
                "buttonWithQuantity": true
              },
              "styles": {
                "product": {
                  "@media (min-width: 601px)": {
                    "max-width": "100%",
                    "margin-left": "0px",
                    "margin-bottom": "0px"
                  }
                },
                "button": {
                  "font-weight": "bold",
                  ":hover": {
                    "background-color": "#20a714"
                  },
                  "background-color": "#20a714",
                  ":focus": {
                    "background-color": "#20a714"
                  },
                  "border-radius": "40px",
                  "padding-left": "95px",
                  "padding-right": "95px"
                }
              },
              "text": {
                "button": "Add to cart"
              }
            },
            "option": {},
            "cart": {
              "styles": {
                "button": {
                  "font-weight": "bold",
                  ":hover": {
                    "background-color": "#20a714"
                  },
                  "background-color": "#20a714",
                  ":focus": {
                    "background-color": "#20a714"
                  },
                  "border-radius": "40px"
                }
              },
              "text": {
                "total": "Subtotal",
                "button": "Checkout"
              },
              "popup": false,
              "events": {
                "afterInit": function(cart) {
                  cart.onCheckout = function() {
                    try {
                      // 🚨 VERIFICAR SE PODE FAZER CHECKOUT
                      if (!window.UnifiedTracking.canInitiateCheckout()) {
                        console.log('🚫 Checkout bloqueado pelo rate limiting');
                        return false; // Bloquear o checkout
                      }
                      
                      // 🚨 MARCAR CHECKOUT COMO EM ANDAMENTO
                      window.UnifiedTracking.checkoutInProgress = true;
                      window.UnifiedTracking.lastCheckoutTime = Date.now();
                      
                      // Pegar UTMs essenciais
                      const utmParams = new URLSearchParams(window.location.search);
                      const quizData = JSON.parse(localStorage.getItem('thunder_quiz_data') || '{}');
                      
                      // Apenas UTMs essenciais
                      const essentialUtms = {
                        utm_source: utmParams.get('utm_source') || quizData.utm_source || 'direct',
                        utm_medium: utmParams.get('utm_medium') || quizData.utm_medium || 'none',
                        utm_campaign: utmParams.get('utm_campaign') || quizData.utm_campaign || 'none'
                      };

                      // Enviar para Meta Pixel
                      fbq('track', 'InitiateCheckout P3', {
                        value: 49.99,
                        currency: 'USD',
                        content_type: 'product',
                        content_ids: ['OKCTYZ0013'],
                        custom_data: {
                          ...essentialUtms,
                          p3initiate: 'true'
                        }
                      });

                      // Enviar para TikTok
                      ttq.track('InitiateCheckout P3', {
                        content_type: 'product',
                        content_id: 'OKCTYZ0013',
                        quantity: 1,
                        value: 49.99,
                        currency: 'USD',
                        p3initiate: 'true',
                        ...essentialUtms
                      });
                      
                      // Construir URL do checkout apenas com UTMs essenciais
                      const utmString = Object.entries(essentialUtms)
                        .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
                        .join('&');
                      
                      // Pegar URL base do checkout
                      const checkoutUrl = cart.model.webUrl;
                      if (!checkoutUrl) {
                        console.error('❌ URL do checkout não encontrada');
                        // 🚨 RESETAR STATUS SE FALHAR
                        window.UnifiedTracking.checkoutInProgress = false;
                        return true;
                      }
                      
                      // Adicionar UTMs
                      const finalUrl = checkoutUrl + (checkoutUrl.includes('?') ? '&' : '?') + utmString;
                      
                      // Debug
                      console.log('🛒 Checkout URL:', finalUrl);
                      
                      // 🚨 ADICIONAR DELAY ANTES DO REDIRECT
                      setTimeout(() => {
                        window.location = finalUrl;
                      }, 500);
                      
                      return false;
                    } catch (error) {
                      console.error('❌ Erro no checkout:', error);
                      // 🚨 RESETAR STATUS EM CASO DE ERRO
                      window.UnifiedTracking.checkoutInProgress = false;
                      return true;
                    }
                  };
                }
              }
            },
            "toggle": {
              "styles": {
                "toggle": {
                  "font-weight": "bold",
                  "background-color": "#20a714",
                  ":hover": {
                    "background-color": "#20a714"
                  },
                  ":focus": {
                    "background-color": "#20a714"
                  }
                }
              }
            }
          };

          // 📦 USAR PRODUTOS CENTRALIZADOS
          const products = window.ShopifyHelper?.getProducts() || [
            {
              id: '14698442916205',
              nodeId: 'product-component-1750959272674',
              isRelated: false
            },
            {
              id: '14698442916205',
              nodeId: 'product-component-1750658269915',
              isRelated: false
            },
            {
              id: '14698443932013',
              nodeId: 'product-component-1750960182776',
              isRelated: true,
              type: 'cap'
            },
            {
              id: '14698444128621',
              nodeId: 'product-component-1750960235069',
              isRelated: true,
              type: 'ball'
            },
            {
              id: '14698443342189',
              nodeId: 'product-component-1750960334759',
              isRelated: true,
              type: 'pack'
            }
          ];

          // Configuração específica para botões de produtos relacionados
          const relatedProductOptions = {
            "product": {
              "styles": {
                "product": {
                  "@media (min-width: 601px)": {
                    "max-width": "100%",
                    "margin-left": "0",
                    "margin-bottom": "0"
                  }
                },
                "button": {
                  "font-size": "10px",
                  "padding": "5px 10px",
                  "width": "100%",
                  "font-weight": "bold",
                  ":hover": {
                    "background-color": "#20a714"
                  },
                  "background-color": "#20a714",
                  ":focus": {
                    "background-color": "#20a714"
                  },
                  "border-radius": "4px"
                }
              },
              "contents": {
                "img": false,
                "title": false,
                "price": false
              },
              "text": {
                "button": "Add to cart"
              }
            },
            "cart": {
              "styles": {
                "button": {
                  "font-weight": "bold",
                  ":hover": {
                    "background-color": "#20a714"
                  },
                  "background-color": "#20a714",
                  ":focus": {
                    "background-color": "#20a714"
                  },
                  "border-radius": "40px"
                }
              },
              "text": {
                "total": "Subtotal",
                "button": "Checkout"
              },
              "popup": false,
              "events": {
                "afterInit": function(cart) {
                  // Monitorar mudanças no carrinho
                  cart.onLineItemAdd = function(lineItem) {
                    // Se o pack foi adicionado 
                    if (lineItem.variant.product.id === '14698444128621') {
                      console.log('🛒 Pack adicionado');
                    }
                  };
                }
              }
            }
          };

          // Criar componente para cada produto
          products.forEach(product => {
            const node = document.getElementById(product.nodeId);
            if (node) {
              window.ShopifyBuy.UI.onReady(client).then(function (ui) {
                ui.createComponent('product', {
                  id: product.id,
                  node: node,
                  moneyFormat: '%24%7B%7Bamount%7D%7D',
                  options: product.isRelated ? relatedProductOptions : defaultOptions
                });
              });
            } else {
              console.warn(`⚠️ Elemento não encontrado: ${product.nodeId}`);
            }
          });
        }
      };

      // Executar quando a página carregar
      document.addEventListener('DOMContentLoaded', function() {
        window.captureQuizData();
        window.initializeShopifyWithUTM();
        
        // Limpeza periódica do cache
        setInterval(() => {
          window.UnifiedTracking.cleanOldEvents();
        }, 10 * 60 * 1000);
      });

      // 🚨 INICIALIZAR SISTEMA AUTOMATICAMENTE
      window.UnifiedTracking.init();
    </script>
  </head>
  <body>
    <!-- Meta Pixel Noscript -->
    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=10005843282818404&ev=PageView&noscript=1"
      />
    </noscript>
    
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>

